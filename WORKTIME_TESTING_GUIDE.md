# Руководство по тестированию системы отработки отгулов

## Обзор системы

Система отработки отгулов теперь включает:

1. **Ручное управление таймерами** - сотрудники запускают/останавливают таймеры самостоятельно
2. **Real-time уведомления** - WebSocket уведомления для всех участников процесса
3. **Автоматический расчет** - пересчет отработки на основе отчетов входа-выхода
4. **Статусы отработки** - полный жизненный цикл от "Не начато" до "Отработано"
5. **История отработок** - ведение журнала всех отработок

## Жизненный цикл отработки

### 1. Начальное состояние
- **Статус**: "Не начато"
- **Условие**: У сотрудника есть утвержденный отгул
- **Действие**: Сотрудник видит кнопки запуска таймеров

### 2. Процесс отработки
- **Статус**: "В процессе"
- **Условие**: Таймер запущен, но требуемое время не достигнуто
- **Действие**: Таймер работает в реальном времени

### 3. Завершение отработки
- **Статус**: "На проверке"
- **Условие**: Достигнуто требуемое время отработки
- **Действия**:
  - Автоматическая остановка таймеров
  - Уведомление сотрудника о завершении
  - Уведомление HR о необходимости проверки
  - Создание записи в истории

### 4. Подтверждение HR
- **Статус**: "Отработано"
- **Условие**: HR подтверждает отработку
- **Действия**:
  - Уведомление сотрудника о подтверждении
  - Запись в историю отработок
  - Обновление статуса во всех интерфейсах

## Пошаговое тестирование

### Подготовка к тестированию

1. **Создайте тестовых пользователей**:
   - Сотрудник (роль: employee)
   - HR-менеджер (роль: hr)
   - Администратор (роль: admin)

2. **Создайте отгул**:
   - Подайте заявку на отгул от имени сотрудника
   - Утвердите заявку от имени HR
   - Убедитесь, что отгул попадает на текущую дату

### Тест 1: Запуск и остановка таймера

**Цель**: Проверить ручное управление таймерами

**Шаги**:
1. Войдите как сотрудник
2. Откройте модалку "Отработка отгулов"
3. Проверьте отображение панелей таймеров (выходные/будни)
4. Запустите таймер выходных дней
5. Убедитесь, что таймер отображается как работающий
6. Остановите таймер
7. Проверьте, что время сохранилось

**Ожидаемый результат**:
- Таймеры запускаются и останавливаются корректно
- Время накапливается и отображается в реальном времени
- Статус меняется на "В процессе"

### Тест 2: Автоматическое завершение

**Цель**: Проверить автоматическое завершение при достижении требуемого времени

**Шаги**:
1. Запустите таймер
2. Дождитесь или добавьте вручную время до достижения требуемого объема
3. Наблюдайте за автоматическим завершением

**Ожидаемый результат**:
- Таймеры автоматически останавливаются
- Появляется уведомление о завершении отработки
- Статус меняется на "На проверке"
- Проигрывается звуковое уведомление

### Тест 3: Уведомления HR

**Цель**: Проверить получение уведомлений HR-менеджером

**Шаги**:
1. Откройте модалку отработки от имени HR в отдельном браузере/вкладке
2. Завершите отработку от имени сотрудника (Тест 2)
3. Проверьте получение уведомления HR

**Ожидаемый результат**:
- HR получает уведомление о завершении отработки
- В уведомлении указаны детали: кто, сколько требовалось, сколько отработано
- Проигрывается звуковое уведомление для HR

### Тест 4: Подтверждение отработки

**Цель**: Проверить процесс подтверждения HR

**Шаги**:
1. От имени HR откройте HR Панель
2. Найдите сотрудника со статусом "На проверке"
3. Нажмите "Подтвердить отработку"
4. Проверьте изменение статуса

**Ожидаемый результат**:
- Статус меняется на "Отработано"
- Сотрудник получает уведомление о подтверждении
- Запись добавляется в историю

### Тест 5: Автоматический расчет

**Цель**: Проверить автоматический расчет на основе отчетов

**Шаги**:
1. Убедитесь, что у сотрудника есть данные входа-выхода за предыдущий день
2. От имени HR нажмите кнопку "Авто-расчет"
3. Выберите дату для расчета
4. Проверьте результаты расчета

**Ожидаемый результат**:
- Система рассчитывает переработку (до 9:00 и после 18:00)
- Учитывается время ручных таймеров
- Автоматически обновляются статусы
- Отправляются уведомления

### Тест 6: История отработок

**Цель**: Проверить ведение истории

**Шаги**:
1. От имени HR нажмите кнопку "История"
2. Проверьте отображение записей в консоли браузера
3. Убедитесь, что все завершенные отработки записаны

**Ожидаемый результат**:
- История содержит все записи отработок
- Указаны даты, пользователи, статусы
- Возможна фильтрация по параметрам

## Тестирование WebSocket соединений

### Real-time обновления

1. **Откройте несколько вкладок**:
   - Сотрудник в одной вкладке
   - HR в другой вкладке

2. **Проверьте синхронизацию**:
   - Запуск/остановка таймеров отображается у HR
   - Завершение отработки уведомляет HR
   - Подтверждение HR уведомляет сотрудника

3. **Проверьте обновления данных**:
   - Изменения статусов отображаются в реальном времени
   - Обновляются прогресс-бары и таймеры
   - Синхронизируются между всеми открытыми окнами

## Возможные проблемы и решения

### Проблема: Таймеры не запускаются
**Решение**: 
- Проверьте, что у пользователя есть активный отгул
- Убедитесь, что текущее время находится вне рабочих часов (для будних дней)
- Проверьте WebSocket соединение

### Проблема: Уведомления не приходят
**Решение**:
- Проверьте WebSocket соединение в консоли браузера
- Убедитесь, что применен патч из websocket-worktime-patch.js
- Проверьте, что пользователи аутентифицированы

### Проблема: Автоматический расчет не работает
**Решение**:
- Проверьте наличие данных в отчетах входа-выхода
- Убедитесь, что у пользователей есть утвержденные отгулы на нужные даты
- Проверьте права доступа для HR/Admin

### Проблема: Статусы не обновляются
**Решение**:
- Проверьте API endpoints /api/worktime-status
- Убедитесь, что база данных обновляется корректно
- Проверьте логи сервера на ошибки

## Дополнительные возможности

### Настройка автоматического пересчета
- Установите node-cron: `npm install node-cron`
- Добавьте код из AUTO_CALCULATE_SCHEDULER в server.js
- Настройте расписание по необходимости

### Расширение уведомлений
- Добавьте email-уведомления
- Интегрируйте с Telegram-ботом
- Настройте push-уведомления

### Аналитика и отчеты
- Создайте дашборд с метриками отработки
- Добавьте экспорт данных в Excel
- Реализуйте графики прогресса

## Заключение

Система отработки отгулов теперь обеспечивает:

✅ **Полный контроль процесса** - от запуска таймера до подтверждения HR
✅ **Real-time уведомления** - все участники получают актуальную информацию
✅ **Автоматизация** - минимум ручной работы для HR
✅ **Прозрачность** - полная история всех операций
✅ **Гибкость** - ручное и автоматическое управление

Система готова к продуктивному использованию!
